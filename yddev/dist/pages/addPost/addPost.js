const app=getApp();Page({data:{postImgList:[],postText:""},onLoad:function(t){},onReady:function(){wx.setNavigationBarTitle({title:"发布帖子"})},initData(){this.setData({postImgList:[],postText:""})},changeThisImg(t){const e=t.currentTarget.dataset.index;let s=this.data.postImgList;wx.chooseImage({count:1,success:t=>{s[e]=t.tempFiles[0],this.setData({postImgList:s})}})},onchooseimg(){let t=this.data.postImgList;wx.chooseImage({count:t.length,success:e=>{(t=[...t,...e.tempFiles]).length>4||this.setData({postImgList:t})}})},oncancel(){this.initData(),wx.navigateBack({delta:1})},oncomfirm(){const t=this.data.postImgList,e=this.data.postText;if(0!==t.length||0!==e.length)if(wx.showLoading({title:"发布中...",mask:!0}),0===t.length){let t={content:this.data.postText,uid:wx.getStorageSync("u_id"),type:1};this.publishPost(t)}else{let e=[],s={};for(let o=0;o<t.length;o++){const a=t[o].path;this.uploadImageToQiniu(a,o=>{e.push(o.key),s={content:this.data.postText,uid:wx.getStorageSync("u_id"),type:2,image_url:e[0],image_key:e.join(",")},e.length==t.length&&this.publishPost(s)})}}},publishPost(t){app.request.publishPost({params:t,success:t=>{1==t.result_code?(wx.hideLoading(),this.oncancel()):(wx.hideLoading(),wx.showModal({title:"发布失败",content:`失败错误码${t.result_code}`,showCancel:!0}))}})},uploadImageToQiniu(t,e){app.request.get7niuImageToken({success:s=>{const o=s.result_data.up_token;app.upload2Qiniu(o),app.qiniuSdk.upload(t,t=>{e(t)})}})},oninputtext(t){const e=t.detail.value;this.setData({postText:e})},onShow:function(){app.request.get7niuImageToken({success:t=>{const e=t.result_data.up_token;app.upload2Qiniu(e),app.qiniuSdk.upload()}})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){}});